# 摄像头状态定时检查快速配置指南

## 一、前置条件检查

1. ✅ 确认已部署后端代码：`CameraStatusTask.java`
2. ✅ 确认已部署前端代码（移除了检查状态按钮）
3. ✅ 确认数据库中存在`sys_job`表（若依框架定时任务表）
4. ✅ 确认服务器网络可以访问摄像头IP

## 二、配置步骤（5分钟完成）

### 步骤1：登录系统管理后台
- 使用管理员账号登录系统
- 进入"系统管理"菜单

### 步骤2：添加定时任务
1. 点击"定时任务"菜单
2. 点击"新增"按钮
3. 填写以下信息：

| 字段 | 值 | 说明 |
|------|-----|------|
| 任务名称 | 摄像头状态检查 | 必填 |
| 任务组名 | DEFAULT | 必填 |
| 调用目标字符串 | cameraStatusTask.checkAllCameraStatus | 必填，注意大小写 |
| cron表达式 | 0 0/5 * * * ? | 每5分钟执行一次 |
| 执行策略 | 立即执行 | 选择"立即执行" |
| 是否并发 | 否 | 选择"否" |
| 状态 | 正常 | 选择"正常"启用任务 |

4. 点击"确定"保存

### 步骤3：启动定时任务
1. 在定时任务列表中找到"摄像头状态检查"
2. 确认状态为"正常"（绿色）
3. 如果状态为"暂停"，点击"启动"按钮

### 步骤4：验证任务执行
1. 等待5分钟
2. 点击"日志"按钮查看执行记录
3. 确认任务执行成功

## 三、验证检查清单

### ✅ 后端验证
```bash
# 1. 查看应用日志
tail -f logs/sys-info.log | grep "摄像头状态检查"

# 应该看到类似输出：
# [INFO] 开始执行摄像头状态检查定时任务
# [INFO] 摄像头状态检查完成 - 总数：10，在线：8，离线：2，错误：0
```

### ✅ 数据库验证
```sql
-- 1. 查看定时任务配置
SELECT job_name, invoke_target, cron_expression, status 
FROM sys_job 
WHERE job_name = '摄像头状态检查';

-- 2. 查看任务执行日志（最近10条）
SELECT job_name, status, create_time, exception_info
FROM sys_job_log 
WHERE job_name = '摄像头状态检查' 
ORDER BY create_time DESC 
LIMIT 10;

-- 3. 查看摄像头状态更新
SELECT camera_code, camera_name, status, update_time 
FROM camera 
ORDER BY update_time DESC 
LIMIT 10;
```

### ✅ 前端验证
1. 登录系统
2. 进入"设备管理" -> "摄像头管理"
3. 确认页面上没有"检查状态"按钮
4. 确认没有"批量检查状态"按钮
5. 观察摄像头状态列显示正常（在线/离线）

## 四、常见问题快速解决

### 问题1：找不到"定时任务"菜单
**解决方案：**
- 确认当前账号有系统管理权限
- 检查菜单权限配置
- 联系系统管理员分配权限

### 问题2：任务执行失败
**解决方案：**
```bash
# 1. 查看错误日志
SELECT exception_info FROM sys_job_log 
WHERE job_name = '摄像头状态检查' 
AND status = '1' 
ORDER BY create_time DESC LIMIT 1;

# 2. 检查调用目标是否正确
# 确保是：cameraStatusTask.checkAllCameraStatus
# 注意：c是小写，S是大写

# 3. 重启应用服务
systemctl restart your-app-service
```

### 问题3：状态没有更新
**解决方案：**
1. 检查定时任务是否正常执行
2. 查看应用日志是否有错误
3. 确认摄像头videoSource字段格式正确
4. 测试网络连接是否正常

### 问题4：执行时间过长
**解决方案：**
- 如果摄像头数量>50，考虑调整检查频率
- 修改cron表达式为：`0 0/10 * * * ?`（每10分钟）
- 或：`0 0/15 * * * ?`（每15分钟）

## 五、Cron表达式快速参考

| 表达式 | 说明 | 适用场景 |
|--------|------|----------|
| 0 0/3 * * * ? | 每3分钟 | 实时性要求很高 |
| 0 0/5 * * * ? | 每5分钟 | 推荐配置 |
| 0 0/10 * * * ? | 每10分钟 | 摄像头数量较多 |
| 0 0/15 * * * ? | 每15分钟 | 一般场景 |
| 0 0/30 * * * ? | 每30分钟 | 实时性要求不高 |
| 0 0 * * * ? | 每小时 | 仅需定期检查 |

## 六、监控建议

### 日常监控
1. 每天查看一次任务执行日志
2. 关注摄像头在线率变化
3. 及时处理离线摄像头

### 告警设置
建议设置以下告警：
- 定时任务连续失败3次
- 摄像头在线率低于80%
- 单个摄像头离线超过30分钟

## 七、联系支持

如遇到无法解决的问题，请提供以下信息：
1. 定时任务配置截图
2. 任务执行日志
3. 应用错误日志
4. 摄像头数量和网络环境

---

**配置完成！** 🎉

现在系统会每5分钟自动检查所有摄像头的在线状态，无需手动操作。
