# 设备在线状态查询功能实现说明

## 功能概述
为摄像头管理系统添加设备在线状态查询功能，通过ping摄像头IP地址来检测设备是否在线。

## 后端实现

### 1. Controller层 (CameraController.java)
添加了两个新接口：

#### 检查单个摄像头在线状态
```java
@GetMapping("/checkOnlineStatus/{id}")
public AjaxResult checkOnlineStatus(@PathVariable("id") Long id)
```
- 权限：`device:camera:query`
- 参数：摄像头ID
- 返回：boolean值，true表示在线，false表示离线

#### 批量检查摄像头在线状态
```java
@PostMapping("/batchCheckOnlineStatus")
public AjaxResult batchCheckOnlineStatus(@RequestBody Long[] ids)
```
- 权限：`device:camera:query`
- 参数：摄像头ID数组
- 返回：Map<Long, Boolean>，key为摄像头ID，value为在线状态

### 2. Service层 (ICameraService.java & CameraServiceImpl.java)

#### 核心方法实现

**checkCameraOnlineStatus(Camera camera)**
- 从videoSource中提取IP地址
- 使用InetAddress.isReachable()方法ping IP
- 超时时间：2秒

**batchCheckOnlineStatus(Long[] ids)**
- 批量检查多个摄像头状态
- 自动更新数据库中的status字段
- 返回所有摄像头的在线状态

**extractIpFromVideoSource(String videoSource)**
- 支持多种视频源格式：
  - rtsp://192.168.1.100:554/stream
  - http://192.168.1.100/stream
  - https://192.168.1.100/stream
- 使用正则表达式提取IP地址

**pingHost(String ip)**
- 使用Java原生API进行ping操作
- 超时时间：2000毫秒
- 返回是否可达

## 前端实现

### 1. API接口 (camera.js)
添加了两个新的API方法：

```javascript
// 检查摄像头在线状态
export function checkOnlineStatus(id)

// 批量检查摄像头在线状态
export function batchCheckOnlineStatus(ids)
```

### 2. 摄像头管理页面 (carmera/index.vue)

#### 新增功能
1. **单个检查按钮**
   - 位置：每行操作列
   - 图标：Refresh
   - 功能：检查单个摄像头在线状态
   - 加载状态：显示loading动画

2. **批量检查按钮**
   - 位置：工具栏
   - 图标：Refresh
   - 功能：批量检查选中的摄像头状态
   - 需要至少选中一个摄像头
   - 显示检查结果统计

#### 实现的方法
```javascript
// 检查单个摄像头状态
async function handleCheckStatus(row)

// 批量检查摄像头状态
async function handleBatchCheckStatus()
```

### 3. AI设置页面 (AISettings/index.vue)
需要添加类似的检查状态功能（待完成）

## 技术特点

1. **IP提取智能化**
   - 支持多种视频源协议
   - 使用正则表达式精确匹配
   - 容错处理

2. **Ping实现**
   - 使用Java原生API
   - 设置合理的超时时间
   - 异常处理完善

3. **状态自动更新**
   - 批量检查时自动更新数据库
   - 前端实时显示状态变化
   - 提供详细的统计信息

4. **用户体验优化**
   - Loading状态提示
   - 操作结果反馈
   - 批量操作统计

## 使用说明

### 单个检查
1. 在摄像头列表中找到目标摄像头
2. 点击操作列的"检查状态"按钮
3. 等待检查完成，查看状态更新

### 批量检查
1. 勾选需要检查的摄像头
2. 点击工具栏的"批量检查状态"按钮
3. 等待检查完成，查看统计结果

## 注意事项

1. **网络环境**
   - 确保服务器能够访问摄像头网络
   - 防火墙需要允许ICMP协议

2. **超时设置**
   - 当前超时时间为2秒
   - 可根据实际网络情况调整

3. **权限要求**
   - 需要`device:camera:query`权限
   - 确保用户有相应权限

4. **性能考虑**
   - 批量检查时会逐个ping
   - 大量摄像头可能需要较长时间
   - 建议分批检查

## 测试建议

1. 测试正常在线的摄像头
2. 测试离线的摄像头
3. 测试无效的视频源格式
4. 测试批量检查功能
5. 测试权限控制
6. 测试网络超时情况

## 后续优化建议

1. 添加异步批量检查，提高性能
2. 添加定时自动检查功能
3. 添加状态变化通知
4. 优化大批量检查的性能
5. 添加检查历史记录
