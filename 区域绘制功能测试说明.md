# 区域绘制功能测试说明

## 功能概述

区域绘制功能允许用户在摄像头视频画面上绘制多边形区域，用于配置AI检测的区域范围。支持多种区域类型，包括车道区、实线、拥堵区、禁行区等。

## 测试环境准备

### 1. 数据库准备

确保 `camera` 表中已有 `camera_url` 字段和测试数据：

```sql
-- 检查字段是否存在
SHOW COLUMNS FROM camera LIKE 'camera_url';

-- 如果不存在，执行升级脚本
SOURCE sql/camera_update.sql;
```

### 2. 启动后端服务

```bash
# 启动Spring Boot应用
./ry.sh
```

### 3. 启动前端服务

```bash
cd yulo-ui
npm run dev
```

## 测试步骤

### 方式一：在系统中测试

1. **访问AI设置页面**
   - 登录系统
   - 进入"AI设置"菜单
   - 找到任意一个摄像头

2. **打开区域绘制对话框**
   - 点击操作列的"区域绘制"按钮
   - 弹出区域绘制对话框
   - 确认视频正常播放（来自 camera_url 字段）

3. **选择区域类型**
   - 在下拉框中选择区域类型（如"车道区"）
   - 点击"新增"按钮
   - 确认区域列表中出现新的区域编号

4. **绘制区域**
   - 选中刚添加的区域（点击区域编号）
   - 点击"开始绘制"按钮
   - 在视频画面上点击标记顶点（至少3个点）
   - 点击"结束绘制"按钮
   - 确认区域已绘制完成并显示在画面上

5. **添加多个区域**
   - 重复步骤3-4，添加不同类型的区域
   - 确认每个区域都有独立的编号
   - 确认可以选中不同的区域查看

6. **编辑区域属性**（可选）
   - 选中一个区域
   - 点击"编辑区域属性"
   - 修改车道方向、车道类型、限速等信息
   - 点击确定保存

7. **删除区域**
   - 鼠标悬停在区域编号上
   - 点击右上角的删除按钮
   - 确认区域被删除

8. **保存到数据库**
   - 点击"保存区域"按钮
   - 确认提示保存成功
   - 刷新页面，再次打开区域绘制对话框
   - 确认之前绘制的区域仍然存在

### 方式二：使用独立测试页面

1. **打开测试页面**
   ```bash
   # 在浏览器中打开
   open test-region-draw.html
   ```

2. **测试基本功能**
   - 选择区域类型
   - 点击"新增区域"
   - 选中区域
   - 点击"开始绘制"
   - 在视频上点击标记顶点
   - 点击"结束绘制"

3. **测试高级功能**
   - 添加多个区域
   - 删除区域
   - 清空所有区域
   - 导出数据（查看JSON格式）

## 测试要点

### 1. 视频播放测试

- [ ] 视频能正常加载和播放
- [ ] 视频地址来自 camera_url 字段
- [ ] 视频画面清晰，尺寸合适
- [ ] 摄像头编号和时间戳正确显示

### 2. 区域类型测试

测试所有区域类型是否可用：
- [ ] 车道区 (Lane)
- [ ] 实线 (line_type.diagonal_line)
- [ ] 拥堵区 (congestion_area)
- [ ] 禁行区 (lane_type.disjoint_lane)
- [ ] 人、非机械禁区 (person_invasion)
- [ ] 车辆屏蔽区 (vehicle_mask_area)
- [ ] 拥堵统计区 (congestion_stat_area)
- [ ] 禁停区 (parking_area)

### 3. 绘制功能测试

- [ ] 未选择区域类型时，新增按钮有提示
- [ ] 新增区域后，区域列表正确显示
- [ ] 区域编号自动递增（1, 2, 3...）
- [ ] 选中区域后，高亮显示（绿色）
- [ ] 未选中区域时，开始绘制按钮有提示
- [ ] 开始绘制后，可以在画面上点击标记点
- [ ] 每个点都正确显示（蓝色圆点）
- [ ] 点之间有连线
- [ ] 少于3个点时，结束绘制有提示
- [ ] 结束绘制后，多边形自动闭合
- [ ] 区域中心显示区域编号

### 4. 多区域测试

- [ ] 可以添加多个区域
- [ ] 每个区域独立绘制
- [ ] 选中不同区域时，高亮切换正确
- [ ] 已绘制的区域显示为绿色
- [ ] 选中的区域显示为蓝色
- [ ] 多个区域可以重叠显示

### 5. 删除功能测试

- [ ] 鼠标悬停时显示删除按钮
- [ ] 点击删除按钮可删除区域
- [ ] 删除后区域编号重新排序
- [ ] 删除选中的区域后，选中状态清除

### 6. 保存功能测试

- [ ] 没有区域时，保存按钮有提示
- [ ] 有未绘制的区域时，保存按钮有提示
- [ ] 所有区域绘制完成后，可以保存
- [ ] 保存成功后有提示
- [ ] 保存后刷新页面，数据仍然存在
- [ ] 数据格式正确（JSON格式）

### 7. 界面交互测试

- [ ] 对话框尺寸合适（90%宽度）
- [ ] 视频和控制面板布局合理
- [ ] 按钮状态正确（启用/禁用）
- [ ] 鼠标悬停效果正常
- [ ] 点击响应及时
- [ ] 提示信息清晰明确

### 8. 数据格式测试

检查保存的数据格式是否正确：

```json
[
  {
    "id": 1,
    "type": "Lane",
    "typeName": "车道区",
    "points": [[100, 200], [300, 200], [300, 400], [100, 400]],
    "direction": "up",
    "laneType": "lane",
    "minSpeed": 60,
    "maxSpeed": 120
  },
  {
    "id": 2,
    "type": "congestion_area",
    "typeName": "拥堵区",
    "points": [[500, 300], [700, 300], [700, 500], [500, 500]],
    "direction": "up",
    "laneType": "lane",
    "minSpeed": null,
    "maxSpeed": null
  }
]
```

## 常见问题

### 1. 视频无法播放

**问题**：打开对话框后视频不显示或无法播放

**解决方案**：
- 检查 camera_url 字段是否有值
- 检查视频地址是否可访问
- 检查浏览器是否支持视频格式
- 检查网络连接是否正常

### 2. 画布尺寸不正确

**问题**：画布尺寸与视频不匹配

**解决方案**：
- 等待视频加载完成后再绘制
- 检查 video.videoWidth 和 video.videoHeight
- 刷新页面重新加载

### 3. 点击位置不准确

**问题**：点击的位置与实际标记的位置不一致

**解决方案**：
- 检查画布的缩放比例计算
- 确保画布使用 transform: translate(-50%, -50%) 居中
- 检查 getBoundingClientRect() 的计算

### 4. 保存失败

**问题**：点击保存按钮后提示失败

**解决方案**：
- 检查后端服务是否正常运行
- 检查 updateCamera API 是否正常
- 查看浏览器控制台的错误信息
- 检查数据格式是否正确

### 5. 数据丢失

**问题**：刷新页面后绘制的区域消失

**解决方案**：
- 确认已点击"保存区域"按钮
- 检查数据库中 regions 字段是否有值
- 检查数据解析逻辑是否正确

## 性能测试

### 1. 大量区域测试

- 添加10个以上的区域
- 检查绘制性能是否流畅
- 检查保存和加载速度

### 2. 复杂多边形测试

- 绘制包含10个以上顶点的多边形
- 检查绘制效果是否正常
- 检查数据大小是否合理

### 3. 长时间使用测试

- 连续操作30分钟以上
- 检查是否有内存泄漏
- 检查视频播放是否稳定

## 测试数据示例

### 测试用例1：车道区

```json
{
  "id": 1,
  "type": "Lane",
  "typeName": "车道区",
  "points": [[200, 300], [800, 300], [800, 600], [200, 600]],
  "direction": "up",
  "laneType": "lane",
  "minSpeed": 60,
  "maxSpeed": 120
}
```

### 测试用例2：禁停区

```json
{
  "id": 2,
  "type": "parking_area",
  "typeName": "禁停区",
  "points": [[100, 100], [400, 100], [400, 250], [100, 250]],
  "direction": "up",
  "laneType": "lane",
  "minSpeed": null,
  "maxSpeed": null
}
```

### 测试用例3：拥堵区

```json
{
  "id": 3,
  "type": "congestion_area",
  "typeName": "拥堵区",
  "points": [[500, 400], [900, 400], [900, 700], [500, 700]],
  "direction": "up",
  "laneType": "lane",
  "minSpeed": null,
  "maxSpeed": null
}
```

## 测试报告模板

### 测试信息

- 测试人员：
- 测试日期：
- 测试环境：
- 浏览器版本：

### 测试结果

| 测试项 | 测试结果 | 备注 |
|--------|----------|------|
| 视频播放 | ✅ / ❌ | |
| 区域类型选择 | ✅ / ❌ | |
| 区域绘制 | ✅ / ❌ | |
| 区域删除 | ✅ / ❌ | |
| 数据保存 | ✅ / ❌ | |
| 数据加载 | ✅ / ❌ | |
| 界面交互 | ✅ / ❌ | |

### 发现的问题

1. 问题描述：
   - 重现步骤：
   - 预期结果：
   - 实际结果：
   - 严重程度：

### 改进建议

1. 
2. 
3. 

## 下一步计划

- [ ] 完成基本功能测试
- [ ] 修复发现的问题
- [ ] 优化用户体验
- [ ] 添加更多区域类型
- [ ] 支持区域属性编辑
- [ ] 添加区域模板功能
- [ ] 支持批量导入导出
