# 摄像头状态定时检查功能实现说明

## 功能概述
实现定时任务自动检查所有摄像头的在线状态，并更新数据库中的status字段。移除前端页面上的手动检查状态按钮，改为后台自动检查。

## 实现内容

### 1. 后端定时任务

#### 文件：`src/main/java/com/ruoyi/framework/task/CameraStatusTask.java`

**主要方法：**

1. **checkAllCameraStatus()**
   - 功能：检查所有摄像头的在线状态
   - 执行流程：
     - 查询所有摄像头列表
     - 逐个检查每个摄像头的在线状态
     - 只有状态发生变化时才更新数据库
     - 记录详细的日志信息
   - 统计信息：在线数量、离线数量、错误数量

2. **checkCameraStatusById(Long cameraId)**
   - 功能：检查指定摄像头的在线状态
   - 参数：摄像头ID
   - 用途：可用于单独检查某个摄像头

**特点：**
- 完善的异常处理
- 详细的日志记录
- 只在状态变化时更新数据库，减少数据库操作
- 提供统计信息

### 2. 定时任务配置

#### 文件：`sql/camera_status_task.sql`

**配置说明：**
- 任务名称：摄像头状态检查
- 任务组名：DEFAULT
- 调用目标：cameraStatusTask.checkAllCameraStatus
- Cron表达式：0 0/5 * * * ? (每5分钟执行一次)
- 执行策略：立即执行
- 是否并发：否
- 状态：正常

**Cron表达式选项：**
```
0 0/5 * * * ?   - 每5分钟执行一次（推荐）
0 0/10 * * * ?  - 每10分钟执行一次
0 0/30 * * * ?  - 每30分钟执行一次
0 0 * * * ?     - 每小时执行一次
0 0 0/2 * * ?   - 每2小时执行一次
```

### 3. 前端页面修改

#### 文件：`yulo-ui/src/views/deviceManage/carmera/index.vue`

**移除的功能：**
1. 移除"检查状态"按钮（单个检查）
2. 移除"批量检查状态"按钮
3. 移除相关的方法：
   - handleCheckStatus()
   - handleBatchCheckStatus()
4. 移除相关的状态变量：
   - batchChecking
5. 移除相关的API导入：
   - checkOnlineStatus
   - batchCheckOnlineStatus

**保留的功能：**
- 状态显示（在线/离线标签）
- 其他操作按钮（开始拉流、停止拉流、修改、删除）

## 配置步骤

### 1. 部署后端代码
```bash
# 确保CameraStatusTask.java已部署到服务器
# 重启应用使定时任务类生效
```

### 2. 配置定时任务

**方式一：通过系统管理界面配置**
1. 登录系统管理后台
2. 进入"系统管理" -> "定时任务"
3. 点击"新增"按钮
4. 填写以下信息：
   - 任务名称：摄像头状态检查
   - 任务组名：DEFAULT
   - 调用目标字符串：cameraStatusTask.checkAllCameraStatus
   - cron表达式：0 0/5 * * * ?
   - 执行策略：立即执行
   - 是否并发：否
   - 状态：正常
5. 保存并启动任务

**方式二：通过SQL脚本配置**
```sql
-- 执行 sql/camera_status_task.sql 文件
-- 注意：需要确保sys_job表存在
```

### 3. 部署前端代码
```bash
# 构建前端项目
cd yulo-ui
npm run build:prod

# 部署到服务器
```

## 验证测试

### 1. 检查定时任务是否启动
```sql
-- 查询定时任务配置
SELECT * FROM sys_job WHERE job_name = '摄像头状态检查';

-- 查看任务执行日志
SELECT * FROM sys_job_log WHERE job_name = '摄像头状态检查' ORDER BY create_time DESC LIMIT 10;
```

### 2. 查看应用日志
```bash
# 查看定时任务执行日志
tail -f logs/sys-info.log | grep "摄像头状态检查"
```

### 3. 验证状态更新
```sql
-- 查看摄像头状态
SELECT camera_code, camera_name, status, update_time 
FROM camera 
ORDER BY update_time DESC;
```

### 4. 前端验证
1. 登录系统
2. 进入"设备管理" -> "摄像头管理"
3. 确认没有"检查状态"和"批量检查状态"按钮
4. 观察摄像头状态是否自动更新（等待5分钟）

## 日志说明

### 正常执行日志
```
[INFO] 开始执行摄像头状态检查定时任务
[INFO] 摄像头[摄像头1]状态已更新：0 -> 1
[INFO] 摄像头状态检查完成 - 总数：10，在线：8，离线：2，错误：0
```

### 异常日志
```
[ERROR] 检查摄像头[摄像头1]状态时发生错误：Connection timeout
[ERROR] 执行摄像头状态检查定时任务时发生错误
```

## 性能优化建议

### 1. 调整检查频率
根据实际需求调整cron表达式：
- 对实时性要求高：每3-5分钟
- 一般场景：每10-15分钟
- 对实时性要求不高：每30分钟或每小时

### 2. 批量处理优化
如果摄像头数量很大（>100），可以考虑：
- 分批检查
- 使用线程池并发检查
- 增加超时控制

### 3. 数据库优化
- 只在状态变化时更新数据库
- 使用批量更新减少数据库连接
- 添加索引优化查询性能

## 监控告警

### 建议监控指标
1. 定时任务执行成功率
2. 摄像头在线率
3. 状态检查耗时
4. 异常摄像头数量

### 告警规则建议
1. 定时任务连续失败3次
2. 摄像头在线率低于80%
3. 单次检查耗时超过5分钟
4. 异常摄像头数量超过总数的20%

## 故障排查

### 问题1：定时任务不执行
**排查步骤：**
1. 检查定时任务是否启动：sys_job表中status字段
2. 检查cron表达式是否正确
3. 查看应用日志是否有错误信息
4. 确认CameraStatusTask类是否正确加载

### 问题2：状态更新不准确
**排查步骤：**
1. 检查网络连接是否正常
2. 确认videoSource字段格式是否正确
3. 检查ping超时时间设置
4. 查看详细的错误日志

### 问题3：性能问题
**排查步骤：**
1. 检查摄像头数量
2. 查看单次检查耗时
3. 考虑调整检查频率
4. 优化并发处理

## 注意事项

1. **网络环境**
   - 确保服务器能够访问所有摄像头网络
   - 防火墙需要允许ICMP协议

2. **超时设置**
   - 当前ping超时为2秒
   - 可根据网络情况调整

3. **并发控制**
   - 建议设置为不并发执行
   - 避免多个任务同时检查造成资源竞争

4. **日志管理**
   - 定期清理过期的任务执行日志
   - 避免日志文件过大

5. **数据一致性**
   - 定时任务会自动更新status字段
   - 不要手动修改status字段

## 后续优化方向

1. **异步处理**
   - 使用消息队列异步处理
   - 提高检查效率

2. **智能调度**
   - 根据历史数据调整检查频率
   - 对经常离线的摄像头增加检查频率

3. **状态预测**
   - 基于历史数据预测摄像头状态
   - 提前发现潜在问题

4. **告警通知**
   - 摄像头离线时发送通知
   - 支持多种通知方式（邮件、短信、钉钉等）

5. **可视化监控**
   - 添加摄像头状态监控大屏
   - 实时显示在线率和状态变化趋势
