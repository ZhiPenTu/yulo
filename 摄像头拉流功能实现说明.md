# 摄像头拉流功能实现说明

## 功能概述

本功能为摄像头管理系统添加了基于ZLMediaKit的拉流控制功能，支持：
- 开始拉流：将RTSP视频流拉取到ZLMediaKit服务器
- 停止拉流：停止指定摄像头的拉流
- 状态查询：查询摄像头的拉流状态
- 实时状态显示：在管理界面显示拉流状态

## 技术架构

### 后端实现

1. **DTO类**
   - `StreamRequestDto`: 拉流请求参数
   - `StreamStatusDto`: 拉流状态响应

2. **服务层**
   - `IZLMediaKitService`: ZLMediaKit服务接口
   - `ZLMediaKitServiceImpl`: ZLMediaKit服务实现类

3. **控制器**
   - `CameraController`: 添加拉流相关API接口

### 前端实现

1. **API接口**
   - `startStream()`: 开始拉流
   - `stopStream()`: 停止拉流  
   - `getStreamStatus()`: 查询拉流状态

2. **界面功能**
   - 拉流状态列显示
   - 开始/停止拉流按钮
   - 按钮状态控制（根据拉流状态启用/禁用）

## API接口说明

### 1. 开始拉流
- **URL**: `POST /device/camera/startStream`
- **参数**:
  ```json
  {
    "cameraCode": "摄像头编号",
    "videoSource": "RTSP视频源地址",
    "mediaProxy": "媒体代理"
  }
  ```
- **响应**: 
  ```json
  {
    "code": 200,
    "msg": "开始拉流成功"
  }
  ```

### 2. 停止拉流
- **URL**: `POST /device/camera/stopStream`
- **参数**:
  ```json
  {
    "cameraCode": "摄像头编号",
    "mediaProxy": "媒体代理"
  }
  ```
- **响应**:
  ```json
  {
    "code": 200,
    "msg": "停止拉流成功"
  }
  ```

### 3. 查询拉流状态
- **URL**: `GET /device/camera/streamStatus/{cameraCode}`
- **响应**:
  ```json
  {
    "code": 200,
    "data": {
      "status": "active|inactive|error",
      "message": "状态描述",
      "streamId": "流ID",
      "streamUrl": "播放地址"
    }
  }
  ```

## ZLMediaKit集成

### 配置参数
```yaml
zlmediakit:
  server:
    url: http://35.46.5.76:8080
    secret: MKjn33mg82zrW8TIleMSDlbdxhmhP6yZ
```

### 使用的ZLMediaKit API
1. **addStreamProxy**: 添加拉流代理
2. **delStreamProxy**: 删除拉流代理
3. **getMediaList**: 获取媒体流列表

## 权限控制

新增权限标识：`device:camera:stream`
- 用于控制拉流操作的访问权限
- 需要在系统菜单管理中配置相应权限

## 文件变更清单

### 后端文件
1. `src/main/java/com/ruoyi/project/device/controller/CameraController.java` - 添加拉流API
2. `src/main/java/com/ruoyi/project/device/domain/dto/StreamRequestDto.java` - 新增
3. `src/main/java/com/ruoyi/project/device/domain/dto/StreamStatusDto.java` - 新增
4. `src/main/java/com/ruoyi/project/device/service/IZLMediaKitService.java` - 新增
5. `src/main/java/com/ruoyi/project/device/service/impl/ZLMediaKitServiceImpl.java` - 新增
6. `src/main/resources/application.yml` - 添加ZLMediaKit配置

### 前端文件
1. `yulo-ui/src/api/deviceManage/camera.js` - 添加拉流API
2. `yulo-ui/src/views/deviceManage/carmera/index.vue` - 添加拉流功能

### 测试文件
1. `test-camera-stream.html` - 可视化测试页面
2. `test-camera-stream-api.sh` - API测试脚本

## 部署说明

1. **确保ZLMediaKit服务运行**
   - 访问地址：http://35.46.5.76:8080
   - 管理界面：http://35.46.5.76:8080/webassist/?secret=MKjn33mg82zrW8TIleMSDlbdxhmhP6yZ

2. **配置权限**
   - 在系统管理-菜单管理中添加`device:camera:stream`权限
   - 为相关角色分配权限

3. **重启应用**
   - 重启后端服务以加载新配置
   - 重新构建前端以应用界面变更

## 注意事项

1. **网络连通性**：确保应用服务器能访问ZLMediaKit服务器
2. **RTSP地址**：确保摄像头RTSP地址可访问
3. **资源管理**：及时停止不需要的拉流以节省服务器资源
4. **错误处理**：拉流失败时会在界面显示具体错误信息
5. **状态同步**：页面加载时会自动查询所有摄像头的拉流状态